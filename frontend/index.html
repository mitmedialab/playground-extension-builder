<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="google" value="notranslate">
    <link rel="shortcut icon" href="static/favicon.ico">
    <title>PRG Extension Builder</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        height: 100%;
        background-color: #f0f0f0; /* Light background color for contrast */
      }

      .top-panel {
        width: 100%;
        height: 5.7%;
        background-color: #2c3e50; /* Darker shade to match sidebar */
        color: #ecf0f1; /* Light text color */
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 20px; /* Increased padding for a more spacious look */
        box-sizing: border-box;
        font-size: 18px; /* Slightly larger font size */
        position: fixed; /* Fixed to the top of the page */
        z-index: 3000;
      }

      .top-panel span {
        font-weight: bold;
      }

      #toggleContainerButton {
        background-color: #16a085; /* Match the save button color */
        color: white;
        border: none;
        padding: 8px 15px;
        font-size: 1rem;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s ease;
      }

      #toggleContainerButton:hover {
        background-color: #1abc9c; /* Slightly brighter on hover */
      }

      .container_class {
        width: 100%;
        height: 94.5%; /* Full height minus top panel */
        box-sizing: border-box;
        background-color: #fff; /* White background for content */
        border: 1px solid #ccc; /* Optional: border for clarity */
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* Optional: subtle shadow */
        overflow: auto; /* Handles overflow content */
        position: absolute;
        top: 5.7%; /* Starts below the top panel */
        left: 0px;
        z-index: 1000;
      }

      .editor-panel {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        display: flex;
        height: 90%;
        padding-left: 30px;
        padding-right: 30px;
      }

      #codeEditor {
        width: 100%;
        height: 200px;
        font-family: 'Courier New', Courier, monospace;
        font-size: 14px;
        background-color: #1e1e1e;
        color: #d4d4d4;
        border: 1px solid #333;
        border-radius: 4px;
        padding: 10px;
        box-sizing: border-box;
        resize: vertical; /* Allow vertical resizing */
      }

      #sidebar {
        width: 250px;
        background-color: #2c3e50;
        color: white;
        padding: 20px;
        height: 100%;
        box-sizing: border-box;
        overflow-y: auto;
      }

    #sidebar h3 {
      margin-top: 0;
      font-size: 1.2rem;
      color: #ecf0f1;
    }

    #fileList {
      list-style-type: none;
      padding: 0;
    }

    #fileList li {
      padding: 8px;
      background-color: #34495e;
      margin-bottom: 5px;
      cursor: pointer;
      border-radius: 4px;
      transition: background-color 0.3s ease;
    }

    #fileList li:hover {
      background-color: #16a085;
    }

    #editor {
      flex: 1;
      padding: 20px;
      background-color: white;
      height: 100%;
      box-sizing: border-box;
      overflow-y: auto;
      border: 3px solid #2c3e50;
    }

    #editor h3 {
      margin-top: 0;
      font-size: 1.2rem;
      color: #2c3e50;
    }

    #fileContent {
      width: 100%;
      height: 90%;
      font-family: 'Courier New', Courier, monospace;
      font-size: 1rem;
      padding: 10px;
      background-color: #ecf0f1;
      border: 1px solid #ccc;
      border-radius: 4px;
      resize: none;
      box-sizing: border-box;
    }

    .button-container {
      display: flex;
    }

    .editButton {
      margin-top: 10px;
      padding: 10px 20px;
      background-color: #16a085;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.3s ease;
      margin-right: 10px;
    }

    .editButton:hover {
      background-color: #1abc9c;
    }

    /* Modal Styles */
    .modal {
        display: none;
        position: fixed;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5); /* Semi-transparent background */
        align-items: center;
        justify-content: center;
        z-index: 3000;
    }

    .modal-content {
        background: white;
        padding: 20px;
        border-radius: 5px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.4);
        text-align: center;
        font-size: 24px;
        font-family: Arial, Helvetica, sans-serif;
    }


.modal-footer {
  display: flex;
  justify-content: flex-end;
  margin-top: 10px;
}

.modal-footer button {
  background-color: #16a085;
  color: white;
  border: none;
  padding: 10px 20px;
  font-size: 1rem;
  border-radius: 4px;
  cursor: pointer;
  transition: background-color 0.3s ease;
}

.modal-footer button:hover {
  background-color: #1abc9c;
}


    </style>
    <div class="test">
  <script defer src="runtime.js"></script><script defer src="chunks/vendors-node_modules_pnpm_microbit_microbit-universal-hex_0_2_2_tslib_2_6_2_node_modules_micr-8f889f.6dce1edea4e57eb3ccf5.js"></script><script defer src="chunks/vendors-node_modules_pnpm_core-js_2_6_12_node_modules_core-js_fn_array_includes_js-node_modul-b41ce8.1be7cd83ab653a07364e.js"></script><script defer src="chunks/src_containers_gui_jsx-src_lib_app-state-hoc_jsx-src_lib_hash-parser-hoc_jsx.868d819c85a6b8fa71bd.js"></script><script defer src="gui.js"></script></head>
</div>
  <body>
    <div id="modal" class="modal">
      <div class="modal-content">
        <h2 id="status">Pending</h2>
        <div id="output">Pending</div>
      </div>
    </div>
    <div class="top-panel">
      <span>PRG Extension Builder</span>
      <button id="toggleContainerButton">Show Playground</button>
    </div>
    <div class="container_class" id="mainContainer">
      <h1 style="margin-left:30px; margin-right: 30px">Extension Editor</h1>
      <!-- <div>
        <div id="status"></div>
        <div id="output"></div> 
      </div> -->
      <div class="editor-panel">
        <div id="sidebar">
          <h3>Files</h3>
          <ul id="fileList">
            <!-- File list items will go here -->
          </ul>
        </div>
        <div id="editor">
          <h3>Editor</h3>
          <textarea id="fileContent" placeholder="Select a file to edit..."></textarea>
          <div class="button-container">
            <button class="editButton" id="saveButton">Save</button>
            <button class="editButton" id="buildButton">Preview Extension</button>
          </div>
        </div>
      </div>
    </div>
    <script>

    function removeBodyChildrenExcept() {
      const body = document.body;
      const children = Array.from(body.children); // Get all children of the body

      children.forEach(child => {
        // Remove the child if it doesn't have class "top-panel" or "container"
        if (!child.classList.contains('top-panel') && !child.classList.contains('container_class') && !child.classList.contains('modal')) {
          body.removeChild(child);
        }
      });
    }

      function reloadScripts() {
        const scripts = document.querySelectorAll('script');
        removeBodyChildrenExcept();
        scripts.forEach((script) => {
          const src = script.src;
          if (src) {
            const newScript = document.createElement('script');
            newScript.src = `${src.split('?')[0]}?v=${Date.now()}`; // Add a timestamp to prevent caching
            newScript.defer = true;
            document.body.appendChild(newScript);
          }
        });
        
      }

      const toggleContainerButton = document.getElementById('toggleContainerButton');
      const mainContainer = document.getElementById('mainContainer');
      

      toggleContainerButton.addEventListener('click', () => {
        if (mainContainer.style.display === 'none') {
          mainContainer.style.display = 'block';
          toggleContainerButton.textContent = 'Show Playground';
        } else {
          mainContainer.style.display = 'none';
          toggleContainerButton.textContent = 'Hide Playground';
        }
      });

      const buildButton = document.getElementById('buildButton');
      const saveButton1 = document.getElementById('saveButton'); // New button reference
      const statusElement = document.getElementById('status');
      const outputElement = document.getElementById('output');
      const codeEditor = document.getElementById('codeEditor');

      buildButton.addEventListener('click', async () => {
        //const code = codeEditor.value; // Get the code from the editor
        
        statusElement.textContent = 'Generating preview...';
        outputElement.textContent = ''; // Clear previous output
        console.log("SHOWING FLEX");
        const modal = document.getElementById("modal");
        modal.style.display = "flex";

        try {
          const response = await fetch('/run-command', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            }
          });

          if (response.ok) {
            const message = await response.text(); // Retrieve the response text
            console.log('Success:', message);
            outputElement.textContent = `Success: ${message}`;
            modal.style.display = "none";
            reloadScripts();
            mainContainer.style.display = 'none';
            toggleContainerButton.textContent = 'Hide Playground';

          } else {
            const errorMessage = await response.text();
            console.error('Error:', errorMessage);
            outputElement.textContent = `Error: ${errorMessage}`;

          }
        } catch (error) {
          console.error('Fetch error:', error);
          outputElement.textContent = `Fetch error: ${error.message}`;
        }
      });

      
      const fileList = document.getElementById('fileList');
      const fileContent = document.getElementById('fileContent');
      const saveButton = document.getElementById('saveButton');
      let currentFilePath = null;
  
      // Fetch file list
      async function fetchFileList() {
        console.log("here 2");
        const response = await fetch('/list-directory', { method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            }});
        const files = await response.json();
        console.log("files");
        console.log(files);
        renderFileList(files);
      }
  
      // Render file list
      function renderFileList(files) {
        fileList.innerHTML = '';
        files.forEach(file => {
          const li = document.createElement('li');
          li.textContent = file.name;
          li.className = 'file-item';
          li.onclick = () => openFile(file.path, li);
          fileList.appendChild(li);
        });
      }
  
      // Open file
      async function openFile(filePath, element) {
        const response = await fetch(`/open-file`, { method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ content: filePath })});
        const content = await response.text();
        fileContent.value = content;
        currentFilePath = filePath;
  
        // Highlight active file
        document.querySelectorAll('.file-item').forEach(el => el.classList.remove('active'));
        element.classList.add('active');
      }
  
      // Save file
      saveButton.addEventListener('click', async () => {
        if (!currentFilePath) {
          alert('No file selected!');
          return;
        }
  
        const content = fileContent.value;
        const response = await fetch('/save-file', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ path: currentFilePath, content }),
        });
  
        if (response.ok) {
          alert('File saved successfully!');
        } else {
          alert('Failed to save file.');
        }
      });
  
      fetchFileList();
    </script>
  </body>
</html>
